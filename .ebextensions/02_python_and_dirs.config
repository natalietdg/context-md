container_commands:
  01_create_audio_dirs:
    command: |
      mkdir -p /var/app/current/audio_cache /var/app/current/outputs
      if id webapp >/dev/null 2>&1; then
        chown -R webapp:webapp /var/app/current/audio_cache /var/app/current/outputs || true
      else
        chown -R ec2-user:ec2-user /var/app/current/audio_cache /var/app/current/outputs || true
      fi

  02_create_sys_venv:
    command: |
      if [ ! -d /var/app/venv ]; then
        python3 -m venv /var/app/venv || true
        chown -R webapp:webapp /var/app/venv || true
      fi

  03_install_requirements:
    command: |
      /var/app/venv/bin/pip install --upgrade pip setuptools wheel
      /var/app/venv/bin/pip install --no-cache-dir -r /var/app/current/requirements.txt
    leader_only: false

  04_install_whisperx:
    command: /var/app/venv/bin/pip install --no-cache-dir git+https://github.com/m-bain/whisperx.git
    leader_only: false

  05_verify_install:
    command: |
      echo "Python in use: $(/var/app/venv/bin/python -V 2>&1)"
      /var/app/venv/bin/python - <<'PY'
import importlib,sys
for m in ('boto3','torch','whisperx'):
    try:
        importlib.import_module(m); print(m,'OK')
    except Exception as e:
        print(m,'FAILED ->',e)
PY

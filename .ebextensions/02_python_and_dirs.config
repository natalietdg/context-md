container_commands:
  01_create_audio_dirs:
    command: |
      mkdir -p /var/app/current/audio_cache /var/app/current/outputs
      # set ownership to the web user if it exists, otherwise fallback
      if id webapp >/dev/null 2>&1; then
        chown -R webapp:webapp /var/app/current/audio_cache /var/app/current/outputs || true
      elif id nodejs >/dev/null 2>&1; then
        chown -R nodejs:nodejs /var/app/current/audio_cache /var/app/current/outputs || true
      else
        chown -R ec2-user:ec2-user /var/app/current/audio_cache /var/app/current/outputs || true
      fi

  02_verify_ffmpeg_installation:
    command: |
      echo "=== FFmpeg verification ==="
      which ffmpeg || echo "ffmpeg not found"
      if command -v ffmpeg >/dev/null 2>&1; then
        ffmpeg -version | head -n1 || true
      fi
      echo "PATH: $PATH"

  03_create_sys_venv:
    command: |
      if [ ! -d /var/app/venv ]; then
        python3 -m venv /var/app/venv || true
      fi

  04_activate_and_install_requirements:
    command: |
      set -e
      . /var/app/venv/bin/activate
      pip install --upgrade pip setuptools wheel
      pip install --no-cache-dir -r /var/app/current/requirements.txt
    leader_only: false
    ignoreErrors: false

  05_install_whisperx:
    command: |
      set -e
      . /var/app/venv/bin/activate
      pip install --no-cache-dir git+https://github.com/m-bain/whisperx.git
    leader_only: false
    ignoreErrors: true

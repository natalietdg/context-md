# .ebextensions/02_python_and_dirs.config
container_commands:
  01_create_audio_dirs:
    command: |
      mkdir -p /var/app/current/audio_cache /var/app/current/outputs
      if id webapp >/dev/null 2>&1; then
        chown -R webapp:webapp /var/app/current/audio_cache /var/app/current/outputs || true
      elif id nodejs >/dev/null 2>&1; then
        chown -R nodejs:nodejs /var/app/current/audio_cache /var/app/current/outputs || true
      else
        chown -R ec2-user:ec2-user /var/app/current/audio_cache /var/app/current/outputs || true
      fi

  02_create_system_venv:
    command: |
      if [ ! -d /var/app/venv ]; then
        python3 -m venv /var/app/venv || true
        chown -R webapp:webapp /var/app/venv || true
      fi

  03_activate_and_install_requirements:
    command: |
      set -e
      . /var/app/venv/bin/activate
      pip install --upgrade pip setuptools wheel
      # install main requirements (no-cache to avoid disk caching issues)
      pip install --no-cache-dir -r /var/app/current/requirements.txt
    leader_only: false

  04_install_whisperx:
    command: |
      set -e
      . /var/app/venv/bin/activate
      pip install --no-cache-dir git+https://github.com/m-bain/whisperx.git || true
    leader_only: false

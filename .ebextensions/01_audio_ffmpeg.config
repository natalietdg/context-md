packages:
  yum:
    # try to install epel-release package (if available)
    epel-release: []

commands:
  01_enable_epel:
    command: >
      if command -v amazon-linux-extras >/dev/null 2>&1; then
        amazon-linux-extras enable epel || true;
      fi
    ignoreErrors: true

  02_try_yum_install_ffmpeg:
    command: >
      # Attempt to install ffmpeg from yum repos (may or may not exist)
      if yum list available ffmpeg >/dev/null 2>&1 || yum list ffmpeg >/dev/null 2>&1; then
        yum install -y ffmpeg ffmpeg-devel || true;
      fi
    ignoreErrors: true

  03_install_audio_libraries:
    command: |
      yum install -y \
        alsa-lib-devel \
        pulseaudio-libs-devel \
        sox \
        sox-devel \
        libsndfile \
        libsndfile-devel || true
    ignoreErrors: true

  04_alternative_ffmpeg_static:
    command: |
      # If ffmpeg still not found, download a static build and install to /usr/local/bin
      if ! command -v ffmpeg >/dev/null 2>&1 ; then
        set -e
        cd /tmp
        ARCH=$(uname -m || echo "x86_64")
        if [ "$ARCH" = "x86_64" ]; then
          URL="https://johnvansickle.com/ffmpeg/releases/ffmpeg-release-amd64-static.tar.xz"
        elif [ "$ARCH" = "aarch64" ] || [ "$ARCH" = "arm64" ]; then
          URL="https://johnvansickle.com/ffmpeg/releases/ffmpeg-release-arm64-static.tar.xz"
        else
          URL="https://johnvansickle.com/ffmpeg/releases/ffmpeg-release-amd64-static.tar.xz"
        fi

        if command -v curl >/dev/null 2>&1; then
          curl -sSL --fail -o ffmpeg.tar.xz "$URL" || { echo "curl download failed"; exit 0; }
        elif command -v wget >/dev/null 2>&1; then
          wget -q -O ffmpeg.tar.xz "$URL" || { echo "wget download failed"; exit 0; }
        else
          echo "No downloader (curl/wget) available, skipping static ffmpeg installation"
          exit 0
        fi

        mkdir -p /tmp/ffmpeg_static
        tar -xJf ffmpeg.tar.xz -C /tmp/ffmpeg_static --strip-components=1 || true

        # Copy only if present
        if [ -f /tmp/ffmpeg_static/ffmpeg ]; then
          cp -f /tmp/ffmpeg_static/ffmpeg /usr/local/bin/ || true
          cp -f /tmp/ffmpeg_static/ffprobe /usr/local/bin/ || true
          chmod +x /usr/local/bin/ffmpeg /usr/local/bin/ffprobe || true
          ln -sf /usr/local/bin/ffmpeg /usr/bin/ffmpeg || true
          ln -sf /usr/local/bin/ffprobe /usr/bin/ffprobe || true
        fi
      fi
    ignoreErrors: true

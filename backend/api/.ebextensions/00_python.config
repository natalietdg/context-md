packages:
  yum:
    git: []
    python3: []
    gcc: []
    gcc-c++: []
    make: []
    bzip2-devel: []
    zlib-devel: []
    openssl-devel: []
    libffi-devel: []
    libsndfile: []
    libsndfile-devel: []

commands:
  00_enable_epel:
    command: "amazon-linux-extras install epel -y || true"

  01_install_curl:
    command: "yum -y install curl || true"

  02_install_ffmpeg_static:
    command: |
      if ! command -v ffmpeg >/dev/null 2>&1; then
        TMP=/tmp/ffmpeg-static
        mkdir -p ${TMP}
        curl -L -s -o ${TMP}/ffmpeg.tar.xz "https://johnvansickle.com/ffmpeg/releases/ffmpeg-release-amd64-static.tar.xz"
        tar -xJf ${TMP}/ffmpeg.tar.xz -C ${TMP}
        cp ${TMP}/ffmpeg-*-amd64-static/ffmpeg /usr/local/bin/ || true
        cp ${TMP}/ffmpeg-*-amd64-static/ffprobe /usr/local/bin/ || true
        chmod +x /usr/local/bin/ffmpeg /usr/local/bin/ffprobe || true
      fi

container_commands:
  01_create_venv:
    command: "python3 -m venv /var/app/staging/venv"
    leader_only: true

  02_upgrade_pip_wheels:
    command: "/var/app/staging/venv/bin/pip install --upgrade pip setuptools wheel"
    leader_only: true

  03_pip_install_requirements:
    command: "/var/app/staging/venv/bin/pip install --no-cache-dir --prefer-binary -r /var/app/staging/requirements.txt"
    leader_only: true

  04_cleanup_pip_cache:
    command: "/var/app/staging/venv/bin/pip cache purge || true"
    leader_only: true
